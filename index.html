<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Abdulla's Blog</title>
    <link rel="shortcut icon" type="image/png" href="http://localhost:8080/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="http://localhost:8080/favicon.ico">
    <link href="http://localhost:8080/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Abdulla's Blog Full Atom Feed" />
    <link rel="stylesheet" href="http://localhost:8080/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="http://localhost:8080/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Abdulla Al-Kamil" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="selected"><a href="http://localhost:8080/">Home</a></li>
                <li><a href="http://localhost:8080/pages/about.html">About Me</a></li>
                <li><a href="https://github.com/abdullathedruid">GitHub</a></li>
                <li><a href="http://localhost:8080/tags">Tags</a></li>
                <li><a href="http://localhost:8080/categories">Categories</a></li>
                <li><a href="http://localhost:8080/archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="http://localhost:8080/">Abdulla's Blog</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Aug 22, 2022</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://localhost:8080/0xmonaco.html" rel="bookmark" title="Permanent Link to &quot;0xMonaco&quot;">0xMonaco</a>
                </h2>

                
                

                <h2>Introduction</h2>
<p>Last weekend saw the release of the highly anticipated Paradigm CTF. Amongst the many challenges of varying difficulty, there was a PvP game which involves racing cars against each other. The only catch, however, is that the cars would be controlled by smart contracts! Over the course of 24 hours, developers would deploy new contracts to try and beat each other and to end the competition with the highest ELO. </p>
<p>Within the last minutes, it was neck-and-neck between three teams (OpenSea, JustLurking, and myself) with OpenSea just snatching the win in the very last races. Although I'm gutted I didn't win, I'll take the 2nd place finish. I will include the source code for my car at the bottom of the post, but I'm not sure how much it makes sense without understanding the thought process that went into writing it! Feel free to scroll down to the bottom to have a look.</p>
<p><img alt="Alt Text" src="http://localhost:8080/images/monaco-scoreboard.png"></p>
<h2>The Beginnings</h2>
<p>When the competition started on Saturday night, I was very excited and deployed my first car. My first car (MaxBidCar) was very simple. Just buy 11 acceleration, every round. I didn't win many races, but I certainly managed to get off the start line quickly. I then started to realise that the strategy you should take depends completely on the strategy taken by other players. In this example, I realised that if I had started quickly (because I bought up all the acceleration) there was a chance that the guy behind me hadn't coded any shell mechanism. Indeed, the only races I managed to win are the ones where I didn't get shelled.</p>
<p>I realised I needed to be more clever than this, so I decided to change the amount of acceleration being bought. There was a trade-off between buying as much acceleration as possible vs being economic. I started to think that the optimal strategy would be an economic strategy. After re-reading the rules, I tried to understand the exponential pricing algorithm and come up with a solution. I started with the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// This is cheap speed</span>
<span class="kt">while</span><span class="w"> </span><span class="p">(</span>monaco<span class="p">.</span>getAccelerateCost<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m m-Decimal">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="kt">uint24</span><span class="p">(</span>monaco<span class="p">.</span>buyAcceleration<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// shell someone if shells are cheap, and we are not in lead</span>
<span class="kt">if</span><span class="w"> </span><span class="p">(</span>ourCarIndex<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>monaco<span class="p">.</span>getShellCost<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m m-Decimal">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="kt">uint24</span><span class="p">(</span>monaco<span class="p">.</span>buyShell<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>The documentation had suggested that the "default" price for acceleration was 20, and for shells was 200. Therefore we buy these whenever items whenever we can get them at a bargain - regardless of what our current speed is! I noticed that this strategy was very effective in certain scenarios. When the other two racers were very aggressive, they would spend all their coins early on in the game. Eventually they will both be priced out of taking additional turns. At this point, I can use all the cheap moves to slowly sail across the finish line.</p>
<h2>Economics and Meta-Game Theory</h2>
<p>Any competitive gamer will understand the concept of the 'meta' or 'metagame'. Over time, it became apparent that multiple different strategies were evolving - some would frontload the start of their race, others would save their economy for a push at the end. Some people had different thresholds for which they would prioritise their own speed vs shelling others to reduce their speed. This metagame became apparent to me after watching some of my own races. It almost appeared like the game evolved into rock paper scissors, where the three different behaviours were "acceleratooor", "shellooor", "economicooor".</p>
<p>As my previous strategies had been quite poor, my elo dropped down to the 900s. This became quite frustrating as it became clear that the metagame at elo ~900 was different to ~1100 and ~1300 and ~1500 were all different (Although I didn't have that much time to learn the top meta!). A user that wastes all his coins buying acceleration should be punished by a swift shell from the player behind them, however in some elos there were many cars which never bought any shells! So a "Greedy" algorithm which just max bids acceleration, and hopes that the player behind them doesn't shell them becomes very effective.</p>
<p>Going back to my algorithm, I wanted to expand on the code I highlighted above. I liked this algorithm because it would be cautious when the other two racers were aggressive, and was aggressive when the other players were passive. I decided to converge around the current price of acceleration/shells as an indicator for whether these actions were overbought or not. If acceleration was expensive, I would just sit and wait for it to slow down whilst also shelling everyone in front of me. Unfortunately, I found that most of the time, my car was being too stingy and avoided paying for most actions and so just sat at the start line for most of the race.</p>
<p>After finding out that my car was ending the races with most of its coins, I realised I could be more spend more buying actions than the default cost. Deciding to buy acceleration whenever its price was less than <code>20</code> meant that I didn't buy acceleration a lot of the time, especially at the end of the races when you need acceleration the most! I then created a function <code>getMultipliedInput()</code> which I would use to scale this value. At first I tried 150% scaling (so I would buy acceleration at 30 instead of 20), and then 200%. I then experimented with using other parameters as part of this scaling. I tried looking at the difference between my balance and the average of the others players balance - this wasn't an effective strategy!. I also looked at the number of turns, and distance travelled as methods of estimating "how close are we to the end of the game".</p>
<p>In the end, I chose to use an algorithm that was very similar to the compound interest rate formula utilising a kink. I looked at distance travelled, and number of turns taken in order to calculate how much my car was willing to bid on acceleration/shells. I was able to use the test file supplied in the project folder to test different cars by running <code>forge test -vv</code> to test my car against other example cars. I was able to use this to set some initial variables for the kink distance and sprint factor. This was my first time using foundry, and I was impressed by the speed I was able to iterate over making changes to these variables.</p>
<h2>Summary</h2>
<p>You will have noticed throughout the article I have made many assessments to the functioning of my car. Indeed, it is pointless to make changes to your cars code without having a hypothesis to validate/invalidate these changes. There are many different frameworks for continuous improvement, but broadly they involve 1. coming up with a theory 2. making a change 3. assess response of change 4. repeat. I don't think it's any coincidence that the three teams that came in the top three, all had approximately submissions. I feel like any less than this implied that users were less willing to experiment/make changes with their code. People with more submissions would probably not have had sufficient time to assess the impact of their changes!</p>
<p>Naturally, I would also assume that other people may have spent their time working on the rest of the CTF challenges. So, thanks again to Paradigm for creating an entertaining set of challenges. This was definitely the most amount of fun I've had on-chain, and would love to see some on-going development for 0xMonaco. Now, here's the code you all wanted to see:</p>
<h2>The Code</h2>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.8.13</span><span class="p">;</span><span class="w"></span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;./Car.sol&quot;</span><span class="p">;</span><span class="w"></span>
<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;forge-std/console.sol&quot;</span><span class="p">;</span><span class="w"></span>

<span class="c1">// elo: 965.90 when we start</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">ZoomCar</span><span class="w"> </span><span class="kt">is</span><span class="w"> </span>Car<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">constructor</span><span class="p">(</span>Monaco<span class="w"> </span>_monaco<span class="p">)</span><span class="w"> </span>Car<span class="p">(</span>_monaco<span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">internal </span><span class="nv">constant</span><span class="w"> </span>KINK_DISTANCE<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">700</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">internal </span><span class="nv">constant</span><span class="w"> </span>KINK_FACTOR<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">3</span>_000<span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">internal </span><span class="nv">constant</span><span class="w"> </span>SPRINT_FACTOR<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">11</span>_500<span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">internal </span><span class="nv">constant</span><span class="w"> </span>FINISH_DISTANCE<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getMultipliedInput</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">input</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint32</span><span class="w"> </span><span class="nv">distance</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint16</span><span class="w"> </span><span class="nv">turn</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>distance<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>KINK_DISTANCE<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span>output<span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span>input<span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span>turn<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m m-Decimal">4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span>input<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span>distance<span class="w"> </span><span class="o">*</span><span class="w"> </span>KINK_FACTOR<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>KINK_DISTANCE<span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span>output<span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span>input<span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span>turn<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m m-Decimal">4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span>input<span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span>KINK_FACTOR<span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                        </span><span class="p">(((</span>distance<span class="w"> </span><span class="o">-</span><span class="w"> </span>KINK_DISTANCE<span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>SPRINT_FACTOR<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span>FINISH_DISTANCE<span class="w"> </span><span class="o">-</span><span class="w"> </span>KINK_DISTANCE<span class="p">))))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m m-Decimal">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span>console<span class="p">.</span>log<span class="p">(</span>output<span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">takeYourTurn</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span>Monaco<span class="p">.</span>CarData<span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>allCars<span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">ourCarIndex</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>override<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>Monaco<span class="p">.</span>CarData<span class="w"> </span><span class="kt">memory</span><span class="w"> </span>ourCar<span class="w"> </span><span class="o">=</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="p">];</span><span class="w"></span>

<span class="w">        </span><span class="kt">uint16</span><span class="w"> </span><span class="nv">turn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>monaco<span class="p">.</span>turns<span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// In the final sprint, if we are 2nd:</span>
<span class="w">        </span><span class="c1">// shell the guy ahead if he finishes before us</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>ourCarIndex<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="p">].</span>y<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>KINK_DISTANCE<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">our_ttg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span>FINISH_DISTANCE<span class="w"> </span><span class="o">-</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="p">].</span>y<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                </span>allCars<span class="p">[</span>ourCarIndex<span class="p">].</span>speed<span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">their_ttg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span>FINISH_DISTANCE<span class="w"> </span><span class="o">-</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">].</span>y<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">                </span>allCars<span class="p">[</span>ourCarIndex<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">].</span>speed<span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                </span>their_ttg<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>our_ttg<span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>monaco<span class="p">.</span>getShellCost<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="kt">uint24</span><span class="p">(</span>monaco<span class="p">.</span>buyShell<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// This is cheap speed</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">i</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                </span>monaco<span class="p">.</span>getAccelerateCost<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"></span>
<span class="w">                </span>getMultipliedInput<span class="p">(</span><span class="m m-Decimal">20</span><span class="p">,</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="p">].</span>y<span class="p">,</span><span class="w"> </span>turn<span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="kt">uint24</span><span class="p">(</span>monaco<span class="p">.</span>buyAcceleration<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// if we are in lead, price gouge shells</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">            </span>ourCarIndex<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span>monaco<span class="p">.</span>getShellCost<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"></span>
<span class="w">            </span>getMultipliedInput<span class="p">(</span><span class="m m-Decimal">200</span><span class="p">,</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="p">].</span>y<span class="p">,</span><span class="w"> </span>turn<span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="kt">uint24</span><span class="p">(</span>monaco<span class="p">.</span>buyShell<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// If we aren&#39;t leading:</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>ourCarIndex<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">uint32</span><span class="w"> </span><span class="nv">ahead_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">].</span>speed<span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">shell_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>monaco<span class="p">.</span>getShellCost<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="c1">// If we&#39;re in last, and the guy in first is faster than second</span>
<span class="w">            </span><span class="c1">// We shouldn&#39;t shell, because we want the second guy to shell the first</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shouldShell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>ourCarIndex<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>ahead_speed<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>allCars<span class="p">[</span>ourCarIndex<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">].</span>speed<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span>shouldShell<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="c1">// shell person ahead if their speed is greater than cost of shell</span>
<span class="w">            </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                </span>shouldShell<span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span>shell_cost<span class="w"> </span><span class="o">&lt;</span><span class="w"></span>
<span class="w">                    </span>getMultipliedInput<span class="p">(</span><span class="w"></span>
<span class="w">                        </span>ahead_speed<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">16</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span>allCars<span class="p">[</span>ourCarIndex<span class="p">].</span>y<span class="p">,</span><span class="w"></span>
<span class="w">                        </span>turn<span class="w"></span>
<span class="w">                    </span><span class="p">)</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"></span>
<span class="w">                    </span>ahead_speed<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span>ourCar<span class="p">.</span>balance<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="kt">uint24</span><span class="p">(</span>monaco<span class="p">.</span>buyShell<span class="p">(</span><span class="m m-Decimal">1</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://localhost:8080/0xmonaco.html">posted at 20:27</a>
                    &nbsp;&middot;&nbsp;<a href="http://localhost:8080/category/smart-contracts.html" rel="tag">Smart Contracts</a>
                </div>
            </article>            <h4 class="date">Jun 27, 2022</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://localhost:8080/solidity-vs-vyper-part-1-arithmetic-overflow.html" rel="bookmark" title="Permanent Link to &quot;Solidity vs Vyper (Part 1 - Arithmetic overflow)&quot;">Solidity vs Vyper (Part 1 - Arithmetic overflow)</a>
                </h2>

                
                

                <p>On ethereum, there are two main smart contract languages which are currently being used to deploy smart contracts: Solidity and Vyper. In this series of posts, I will discuss some of the peculiarities of writing smart contracts and use examples from both languages to explain them.</p>
<p>The first contract that we will look at is the <code>ERC20 token</code>, of which there are many examples such as <code>Dai</code>, <code>WETH</code> and <code>UNI</code>. The smart contracts for these tokens act as a distributed ledger, which keeps track of the balances of all users. When a user transfers their tokens to another user, the smart contract must first check whether the user has sufficient balance, and then update the balances of both the sender and receiver. To highlight some of the differences between Solidity and Vyper, I will display just the code required to transfer tokens from the sender to another user. Full implementations can be found for <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">Solidity</a> and <a href="https://github.com/vyperlang/vyper/blob/master/examples/tokens/ERC20.vy">Vyper</a>.</p>
<h2>Solidity</h2>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span><span class="w"></span>

<span class="k">contract</span><span class="w"> </span><span class="ni">ERC20</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>balanceOf<span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">transfer</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">to</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>balanceOf<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>amount<span class="p">;</span><span class="w"></span>
<span class="w">        </span>balanceOf<span class="p">[</span>to<span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>amount<span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<h2>Vyper</h2>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@version</span><span class="w"> </span><span class="o">^</span><span class="mf">0.3.0</span><span class="w"></span>
<span class="nl">balanceOf</span><span class="p">:</span><span class="w"> </span><span class="k">public</span><span class="p">(</span><span class="n">HashMap</span><span class="o">[</span><span class="n">address, uint256</span><span class="o">]</span><span class="p">)</span><span class="w"></span>

<span class="nv">@external</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="n">transfer</span><span class="p">(</span><span class="k">to</span><span class="err">:</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="nl">amount</span><span class="p">:</span><span class="w"> </span><span class="n">uint256</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nl">bool</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">balanceOf</span><span class="o">[</span><span class="n">msg.sender</span><span class="o">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">amount</span><span class="w"></span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">balanceOf</span><span class="o">[</span><span class="n">to</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">True</span><span class="w"></span>
</code></pre></div>

<p>It should be apparent that both smart contract languages are very similar in their implementation of an ERC20 token. Both contracts utilise a mapping from an <code>address</code> to a <code>uint256</code> in order to signify a users balance. </p>
<p>It is important to highlight what would happen with arithmetic over/underflow. If we allow a user to send tokens when they have an insufficient balance, this would result in that user ending with a negative amount of tokens. As the balance is stored as a <code>uint256</code>, this would underflow - causing the user to have a balance in the region of <code>2 ** 256</code> which would obviously be a very serious bug! All versions of Vyper natively check for these arithmetic errors, and cause the transaction to be reverted. This feature was also added to Solidity in version 0.8.0. Anybody choosing to write a contract in an older version of Solidity will need to manually check for over/underflow or utilise a library to do this.</p>
<p>To give an illustration of what would happen if we use an older version of Solidity, I have used the exact same code as presented above but changed the compiler version to 0.7.0. If we run the code, we get the following:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">receiver</span> <span class="o">=</span> <span class="n">accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">overflow_erc20</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">ERC20</span><span class="p">)</span>
<span class="n">Transaction</span> <span class="n">sent</span><span class="p">:</span> <span class="mh">0xd7f0c229b122fb0795d03693222b527c5a7f0077651f36c93ec9e58e01125d8a</span>
  <span class="n">Gas</span> <span class="n">price</span><span class="p">:</span> <span class="mf">0.0</span> <span class="n">gwei</span>   <span class="n">Gas</span> <span class="n">limit</span><span class="p">:</span> <span class="mi">12000000</span>   <span class="n">Nonce</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">ERC20</span><span class="o">.</span><span class="n">constructor</span> <span class="n">confirmed</span>   <span class="n">Block</span><span class="p">:</span> <span class="mi">1</span>   <span class="n">Gas</span> <span class="n">used</span><span class="p">:</span> <span class="mi">116515</span> <span class="p">(</span><span class="mf">0.97</span><span class="o">%</span><span class="p">)</span>
  <span class="n">ERC20</span> <span class="n">deployed</span> <span class="n">at</span><span class="p">:</span> <span class="mh">0x299784aE2AF66133155848a9D2bcAde3B9f5b32c</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">overflow_erc20</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">sender</span><span class="p">})</span>
<span class="n">Transaction</span> <span class="n">sent</span><span class="p">:</span> <span class="mh">0x4383921e24d79d235318c2fbad56a191586ab113f1c515ad94bd500f42c156ad</span>
  <span class="n">Gas</span> <span class="n">price</span><span class="p">:</span> <span class="mf">0.0</span> <span class="n">gwei</span>   <span class="n">Gas</span> <span class="n">limit</span><span class="p">:</span> <span class="mi">12000000</span>   <span class="n">Nonce</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">ERC20</span><span class="o">.</span><span class="n">transfer</span> <span class="n">confirmed</span>   <span class="n">Block</span><span class="p">:</span> <span class="mi">2</span>   <span class="n">Gas</span> <span class="n">used</span><span class="p">:</span> <span class="mi">63634</span> <span class="p">(</span><span class="mf">0.53</span><span class="o">%</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">Transaction</span> <span class="s1">&#39;0x4383921e24d79d235318c2fbad56a191586ab113f1c515ad94bd500f42c156ad&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">overflow_erc20</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">overflow_erc20</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
<span class="mi">115792089237316195423570985008687907853269984665640564039457584007913129639935</span>
</code></pre></div>

<blockquote>
<p>This overflow error has resulted in the user now having more tokens than there are atoms in the universe!</p>
</blockquote>
<p>Developers must be very careful to ensure that these errors do not occur. In particular, it is important to be aware of the different behaviour provided by different compiler versions. When deploying any smart contract, it is important to have the code reviewed (either by external reviewers, or full audits) to reduce the risk of accidentally introducing any error that could result in significant loss for its users.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://localhost:8080/solidity-vs-vyper-part-1-arithmetic-overflow.html">posted at 19:30</a>
                    &nbsp;&middot;&nbsp;<a href="http://localhost:8080/category/smart-contracts.html" rel="tag">Smart Contracts</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://localhost:8080/tag/ethereum.html" class="tags">ethereum</a>
                    &nbsp;<a href="http://localhost:8080/tag/solidity.html" class="tags">solidity</a>
                    &nbsp;<a href="http://localhost:8080/tag/vyper.html" class="tags">vyper</a>
                    &nbsp;<a href="http://localhost:8080/tag/erc20.html" class="tags">erc20</a>
                </div>
            </article>            <h4 class="date">Feb 03, 2022</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://localhost:8080/on-the-topic-of-gas-optimisation.html" rel="bookmark" title="Permanent Link to &quot;On the topic of gas optimisation&quot;">On the topic of gas optimisation</a>
                </h2>

                
                

                <h2>Introduction</h2>
<p>A few topics recently crossed my attention. A user on reddit lost 500K by sending WETH to the WETH contract address</p>
<p><a href="https://www.reddit.com/r/ethereum/comments/sfz4kw/did_i_just_lose_half_a_million_dollars_by_sending">Reddit: Did I just lose half a million dollars by sending WETH to WETH's contract address?</a></p>
<p>There has been some discussion recently on gas optimisations in smart contracts, which has been particularly relevant due to increasing gas prices.</p>
<p>Should a smart contract prevent users from performing actions that would result in the loss of user funds?</p>
<p>Adding extra checks (such as ensuring that the <code>sender</code> and <code>receiver</code> are not the same as the contract address) adds an additional gas stipend onto each transaction.<br>
An argument could be made that it should be the responsibility of wallets and front-ends to prevent these transactions from ever reaching the blockchain. However, given that it is fairly common for tokens to be sent to the contract address, we know that this is not the case.</p>
<p>I thought it would be a good idea to look into this further to decide for myself whether it made sense to add these checks from an economic perspective.</p>
<h3>Idea</h3>
<p>I would write two smart contracts representing ERC20 tokens: an 'unsafe' ERC20 which allows any transfer (ofcourse, the standard rules of balances and approvals will remain) and a 'safe' ERC20 which checks that the receiver and sender are valid addresses (by ensuring that they are not the zero address, or the contract address)</p>
<p>From these contracts, I will get an estimate of the average gas cost for each function. </p>
<p>I will then try and use these figures to get an idea of the gas saving that would have occurred during the lifespan of the WETH contract. I will also get an idea of how much WETH has been 'lost' after being sent to the WETH contract and compare these figures</p>
<h3>Data</h3>
<p>All contracts/scripts are available on <a href="https://github.com/abdullathedruid/gas-cost-erc20">Github</a>.</p>
<p>The gas costs for each of the functions is displayed below, I will be using the average for my calculations. The average has been calculated from 1000 executions with random variables</p>
<div class="highlight"><pre><span></span><code><span class="n">safeERC20</span> <span class="o">&lt;</span><span class="n">Contract</span><span class="o">&gt;</span>
   <span class="err">├─</span> <span class="n">approve</span>      <span class="o">-</span>  <span class="n">avg</span><span class="p">:</span>  <span class="mi">42565</span>  <span class="n">avg</span> <span class="p">(</span><span class="n">confirmed</span><span class="p">):</span>  <span class="mi">42565</span>  <span class="n">low</span><span class="p">:</span>  <span class="mi">24521</span>  <span class="n">high</span><span class="p">:</span>  <span class="mi">44117</span>
   <span class="err">├─</span> <span class="n">transfer</span>     <span class="o">-</span>  <span class="n">avg</span><span class="p">:</span>  <span class="mi">31945</span>  <span class="n">avg</span> <span class="p">(</span><span class="n">confirmed</span><span class="p">):</span>  <span class="mi">31945</span>  <span class="n">low</span><span class="p">:</span>  <span class="mi">27012</span>  <span class="n">high</span><span class="p">:</span>  <span class="mi">35808</span>
   <span class="err">└─</span> <span class="n">transferFrom</span> <span class="o">-</span>  <span class="n">avg</span><span class="p">:</span>  <span class="mi">20442</span>  <span class="n">avg</span> <span class="p">(</span><span class="n">confirmed</span><span class="p">):</span>  <span class="mi">20442</span>  <span class="n">low</span><span class="p">:</span>  <span class="mi">18819</span>  <span class="n">high</span><span class="p">:</span>  <span class="mi">29250</span>
<span class="n">unsafeERC20</span> <span class="o">&lt;</span><span class="n">Contract</span><span class="o">&gt;</span>
   <span class="err">├─</span> <span class="n">approve</span>      <span class="o">-</span>  <span class="n">avg</span><span class="p">:</span>  <span class="mi">42519</span>  <span class="n">avg</span> <span class="p">(</span><span class="n">confirmed</span><span class="p">):</span>  <span class="mi">42519</span>  <span class="n">low</span><span class="p">:</span>  <span class="mi">24475</span>  <span class="n">high</span><span class="p">:</span>  <span class="mi">44071</span>
   <span class="err">├─</span> <span class="n">transfer</span>     <span class="o">-</span>  <span class="n">avg</span><span class="p">:</span>  <span class="mi">31875</span>  <span class="n">avg</span> <span class="p">(</span><span class="n">confirmed</span><span class="p">):</span>  <span class="mi">31875</span>  <span class="n">low</span><span class="p">:</span>  <span class="mi">26942</span>  <span class="n">high</span><span class="p">:</span>  <span class="mi">35738</span>
   <span class="err">└─</span> <span class="n">transferFrom</span> <span class="o">-</span>  <span class="n">avg</span><span class="p">:</span>  <span class="mi">20400</span>  <span class="n">avg</span> <span class="p">(</span><span class="n">confirmed</span><span class="p">):</span>  <span class="mi">20400</span>  <span class="n">low</span><span class="p">:</span>  <span class="mi">18782</span>  <span class="n">high</span><span class="p">:</span>  <span class="mi">29176</span>
</code></pre></div>

<p>In order to get a list of transactions on the WETH contract, I initially performed the following query:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="n">gas_price</span><span class="p">,</span><span class="w"> </span><span class="n">gas</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">bigquery</span><span class="o">-</span><span class="k">public</span><span class="o">-</span><span class="k">data</span><span class="p">.</span><span class="n">crypto_ethereum</span><span class="p">.</span><span class="n">transactions</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tx</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">  </span><span class="n">tx</span><span class="p">.</span><span class="n">to_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&#39;</span><span class="w"></span>
</code></pre></div>

<p>I then realised that this misses out on the majority of transactions on the WETH contract given that many contracts will sub-call the WETH contract, therefore the <code>to</code> address on the transaction will not be the WETH address.</p>
<p>My new updated query looks like:</p>
<div class="highlight"><pre><span></span><code><span class="k">WITH</span><span class="w"> </span><span class="n">traces</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">transaction_hash</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">gas_used</span><span class="p">,</span><span class="w"> </span><span class="k">SUBSTRING</span><span class="p">(</span><span class="n">tr</span><span class="p">.</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">sig_hash</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">bigquery</span><span class="o">-</span><span class="k">public</span><span class="o">-</span><span class="k">data</span><span class="p">.</span><span class="n">crypto_ethereum</span><span class="p">.</span><span class="n">traces</span><span class="o">`</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span><span class="c1">--tracks internal transactions</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">to_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&#39;</span><span class="w"> </span><span class="c1">-- WETH</span>
<span class="k">AND</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">call_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;call&#39;</span><span class="w"></span>
<span class="p">),</span><span class="w"></span>

<span class="n">txs</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">sig_hash</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">tx</span><span class="p">.</span><span class="n">gas_price</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span><span class="n">e9</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">gwei</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">bigquery</span><span class="o">-</span><span class="k">public</span><span class="o">-</span><span class="k">data</span><span class="p">.</span><span class="n">crypto_ethereum</span><span class="p">.</span><span class="n">transactions</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tx</span><span class="w"></span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">traces</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span>
<span class="k">ON</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">transaction_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">hash</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">sig_hash</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">gwei</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">gwei</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">gwei</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">txs</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sig_hash</span><span class="w"></span>
</code></pre></div>

<blockquote>
<p>I didn't think that this query would also return the calls for <code>totalSupply()</code> <code>decimals()</code>, etc. In future queries, I'll make sure to filter these out!</p>
</blockquote>
<p>The script <code>get_gas_saving.py</code> iterates through the functions above and sums the gas saved for each function. The output is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="n">Running</span> <span class="s1">&#39;scripts/get_gas_saving.py::main&#39;</span><span class="o">...</span>
<span class="mf">970677015.604</span> <span class="n">Gwei</span><span class="o">/</span><span class="n">gas</span> <span class="n">spent</span> <span class="n">on</span> <span class="n">performing</span> <span class="n">transferFrom</span><span class="p">()</span><span class="o">.</span> <span class="n">Each</span> <span class="n">function</span> <span class="n">saves</span> <span class="mi">42</span> <span class="n">gas</span>
<span class="n">Total</span> <span class="n">ETH</span> <span class="n">saved</span> <span class="n">by</span> <span class="n">transferFrom</span><span class="p">():</span> <span class="mf">40.768</span>
<span class="o">--</span>
<span class="mf">8570367257.755</span> <span class="n">Gwei</span><span class="o">/</span><span class="n">gas</span> <span class="n">spent</span> <span class="n">on</span> <span class="n">performing</span> <span class="n">transfer</span><span class="p">()</span><span class="o">.</span> <span class="n">Each</span> <span class="n">function</span> <span class="n">saves</span> <span class="mi">70</span> <span class="n">gas</span>
<span class="n">Total</span> <span class="n">ETH</span> <span class="n">saved</span> <span class="n">by</span> <span class="n">transfer</span><span class="p">():</span> <span class="mf">599.926</span>
<span class="o">--</span>
<span class="mf">311808609.989</span> <span class="n">Gwei</span><span class="o">/</span><span class="n">gas</span> <span class="n">spent</span> <span class="n">on</span> <span class="n">performing</span> <span class="n">approve</span><span class="p">()</span><span class="o">.</span> <span class="n">Each</span> <span class="n">function</span> <span class="n">saves</span> <span class="mi">46</span> <span class="n">gas</span>
<span class="n">Total</span> <span class="n">ETH</span> <span class="n">saved</span> <span class="n">by</span> <span class="n">approve</span><span class="p">():</span> <span class="mf">14.343</span>
<span class="o">--</span>
<span class="n">Total</span> <span class="n">ETH</span> <span class="n">saving</span> <span class="n">across</span> <span class="nb">all</span> <span class="n">functions</span><span class="p">:</span> <span class="mf">655.037</span> 
<span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">transactions</span><span class="p">:</span> <span class="mi">91959066</span>
</code></pre></div>

<h2>Discussion</h2>
<p>A cursory glance at the etherscan page shows that the WETH contract has 432.162 WETH lost within the contract, which <em>is</em> lower than the 655 ETH saved in gas fees.<br>
The conclusion that I would draw here is that users of a smart contract would end up overpaying for the additional sanity checks discussed above.</p>
<p>It may be interesting to perform the same query looking at all ERC20 tokens, rather than just WETH to see whether the same conclusion is valid across all ERC20s or just WETH.</p>
<p>However, another argument could be made that it doesn't really make too much of a difference given the sheer number of transactions that have taken place. The difference of 223 ETH, when amortised over 92 million transactions is a value of 0.0000024 ETH per transaction.  </p>
<p>After I published this post, I spoke with a few other people. One interesting perspective was that the additional sanity checks act as a form of socialised insurance. I personally do not mind paying fractionally more on a transaction, knowing that it might prevent somebody else from losing their funds.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://localhost:8080/on-the-topic-of-gas-optimisation.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="http://localhost:8080/category/smart-contracts.html" rel="tag">Smart Contracts</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://localhost:8080/tag/ethereum.html" class="tags">ethereum</a>
                    &nbsp;<a href="http://localhost:8080/tag/vyper.html" class="tags">vyper</a>
                    &nbsp;<a href="http://localhost:8080/tag/gas.html" class="tags">gas</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="http://localhost:8080/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>